const { ethers } = require("hardhat");

// 辅助函数：链接库文件
const linkLibraries = ({ bytecode, linkReferences }, libraries) => {
  Object.keys(linkReferences).forEach((fileName) => {
    Object.keys(linkReferences[fileName]).forEach((contractName) => {
      if (!libraries.hasOwnProperty(contractName)) {
        throw new Error(`Missing library: ${contractName}`);
      }
      const address = libraries[contractName].replace("0x", "").toLowerCase();
      const placeholders = linkReferences[fileName][contractName];
      placeholders.forEach(({ start, length }) => {
        const startByte = start * 2 + 2;
        const lengthByte = length * 2;
        bytecode =
          bytecode.substring(0, startByte) +
          address +
          bytecode.substring(startByte + lengthByte);
      });
    });
  });
  return bytecode;
};

async function main() {
  const [deployer] = await ethers.getSigners();
  console.log("Deploying contracts with the account:", deployer.address);

  // --- 1. 部署 Factory ---
  const Factory = await ethers.getContractFactory("UniswapV3Factory");
  const factory = await Factory.deploy();
  await factory.deployed();
  console.log("UniswapV3Factory deployed to:", factory.address);

  // --- 2. 关键步骤：开启 0.03% (300) 费率 ---
  // 参数1: fee (300 = 0.03%)
  // 参数2: tickSpacing (10 是比较合理的设置，配合低费率)
  await factory.enableFeeAmount(300, 10); 
  console.log(">>> Fee tier 0.03% (300) enabled on Factory!");

  // --- 3. 部署 WETH (Mock) ---
  const WETH9 = await ethers.getContractFactory("MockERC20"); // 这里简化用 Mock 代替
  const weth9 = await WETH9.deploy("Wrapped Ether", "WETH");
  await weth9.deployed();
  console.log("WETH9 deployed to:", weth9.address);

  // --- 4. 部署 SwapRouter ---
  const SwapRouter = await ethers.getContractFactory("SwapRouter");
  const router = await SwapRouter.deploy(factory.address, weth9.address);
  await router.deployed();
  console.log("SwapRouter deployed to:", router.address);

  // --- 5. 部署 PositionManager (需要处理库链接) ---
  const NFTDescriptor = await ethers.getContractFactory("NFTDescriptor");
  const nftDescriptor = await NFTDescriptor.deploy();
  await nftDescriptor.deployed();

  const PositionDescriptorArtifact = require("@uniswap/v3-periphery/artifacts/contracts/NonfungibleTokenPositionDescriptor.sol/NonfungibleTokenPositionDescriptor.json");
  const linkedBytecode = linkLibraries(PositionDescriptorArtifact, {
    NFTDescriptor: nftDescriptor.address,
  });
  
  const PositionDescriptorFactory = await ethers.getContractFactory(
    PositionDescriptorArtifact.abi,
    linkedBytecode,
    deployer
  );
  // native currency label bytes32
  const nativeLabel = ethers.utils.formatBytes32String("ETH");
  const positionDescriptor = await PositionDescriptorFactory.deploy(weth9.address, nativeLabel);
  await positionDescriptor.deployed();

  const NonfungiblePositionManager = await ethers.getContractFactory("NonfungiblePositionManager");
  const positionManager = await NonfungiblePositionManager.deploy(
    factory.address,
    weth9.address,
    positionDescriptor.address
  );
  await positionManager.deployed();
  console.log("NonfungiblePositionManager deployed to:", positionManager.address);

  return { factory, router, positionManager, weth9 };
}

// 导出 main 函数供测试脚本调用，或者直接运行
if (require.main === module) {
  main()
    .then(() => process.exit(0))
    .catch((error) => {
      console.error(error);
      process.exit(1);
    });
}

module.exports = { deployV3System: main };
