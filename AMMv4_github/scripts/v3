mkdir uni-v3-fee-003 && cd uni-v3-fee-003
npm init -y
npm i -D hardhat typescript ts-node @types/node
npm i @uniswap/v3-core @uniswap/v3-periphery @openzeppelin/contracts ethers
npx hardhat init
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract MockERC20 is ERC20 {
    uint8 private _decimals;

    constructor(string memory name_, string memory symbol_, uint8 decimals_) ERC20(name_, symbol_) {
        _decimals = decimals_;
    }

    function decimals() public view override returns (uint8) {
        return _decimals;
    }

    function mint(address to, uint256 amount) external {
        _mint(to, amount);
    }
}
import { ethers } from "hardhat";

// 2^96
const Q96 = BigInt(2) ** BigInt(96);

// sqrtPriceX96 for price = 1:1  => sqrt(1) * 2^96
const SQRT_PRICE_X96_1_1 = Q96;

// fee for 0.03%
const FEE_0_03 = 300; // 0.03%

async function main() {
  const [deployer] = await ethers.getSigners();
  console.log("deployer:", deployer.address);

  // ---- deploy tokens ----
  const MockERC20 = await ethers.getContractFactory("MockERC20");
  const tokenA = await MockERC20.deploy("TokenA", "TKA", 18);
  const tokenB = await MockERC20.deploy("TokenB", "TKB", 18);
  await tokenA.waitForDeployment();
  await tokenB.waitForDeployment();

  const tokenAAddr = await tokenA.getAddress();
  const tokenBAddr = await tokenB.getAddress();
  console.log("tokenA:", tokenAAddr);
  console.log("tokenB:", tokenBAddr);

  // ---- deploy Uniswap V3 Factory ----
  const Factory = await ethers.getContractFactory("UniswapV3Factory");
  const factory = await Factory.deploy();
  await factory.waitForDeployment();
  const factoryAddr = await factory.getAddress();
  console.log("factory:", factoryAddr);

  // ---- deploy WETH9 ----
  const WETH9 = await ethers.getContractFactory("WETH9");
  const weth = await WETH9.deploy();
  await weth.waitForDeployment();
  const wethAddr = await weth.getAddress();
  console.log("weth:", wethAddr);

  // ---- deploy NFT descriptor ----
  // NonfungibleTokenPositionDescriptor needs (WETH9, nativeCurrencyLabelBytes32)
  const PositionDescriptor = await ethers.getContractFactory("NonfungibleTokenPositionDescriptor");
  const nativeLabel = ethers.encodeBytes32String("ETH"); // bytes32
  const descriptor = await PositionDescriptor.deploy(wethAddr, nativeLabel);
  await descriptor.waitForDeployment();
  const descriptorAddr = await descriptor.getAddress();
  console.log("descriptor:", descriptorAddr);

  // ---- deploy NonfungiblePositionManager ----
  const NPM = await ethers.getContractFactory("NonfungiblePositionManager");
  const npm = await NPM.deploy(factoryAddr, wethAddr, descriptorAddr);
  await npm.waitForDeployment();
  const npmAddr = await npm.getAddress();
  console.log("positionManager:", npmAddr);

  // ---- enable new fee amount: 300 (0.03%) ----
  // tickSpacing: choose 10 (commonly used for 0.05% tier). You can choose other reasonable spacing.
  const txEnable = await factory.enableFeeAmount(FEE_0_03, 10);
  await txEnable.wait();
  console.log("enabled fee=300 tickSpacing=10");

  // ---- mint some tokens to deployer ----
  const mintAmount = ethers.parseUnits("1000000", 18);
  await (await tokenA.mint(deployer.address, mintAmount)).wait();
  await (await tokenB.mint(deployer.address, mintAmount)).wait();

  // ---- approvals to position manager ----
  await (await tokenA.approve(npmAddr, mintAmount)).wait();
  await (await tokenB.approve(npmAddr, mintAmount)).wait();

  // ---- create + initialize pool (1:1) ----
  // token ordering: NPM will sort internally in createAndInitializePoolIfNecessary
  const txPool = await npm.createAndInitializePoolIfNecessary(
    tokenAAddr,
    tokenBAddr,
    FEE_0_03,
    SQRT_PRICE_X96_1_1
  );
  await txPool.wait();
  console.log("pool created & initialized");

  // ---- fetch pool address ----
  const poolAddr = await factory.getPool(tokenAAddr, tokenBAddr, FEE_0_03);
  console.log("pool:", poolAddr);

  // ---- mint a position ----
  // For simplicity choose a wide tick range.
  // With tickSpacing=10, tickLower/tickUpper should be multiples of 10.
  const params = {
    token0: tokenAAddr < tokenBAddr ? tokenAAddr : tokenBAddr,
    token1: tokenAAddr < tokenBAddr ? tokenBAddr : tokenAAddr,
    fee: FEE_0_03,
    tickLower: -60000, // multiple of 10
    tickUpper:  60000, // multiple of 10
    amount0Desired: ethers.parseUnits("1000", 18),
    amount1Desired: ethers.parseUnits("1000", 18),
    amount0Min: 0,
    amount1Min: 0,
    recipient: deployer.address,
    deadline: Math.floor(Date.now() / 1000) + 60 * 10,
  };

  const txMint = await npm.mint(params);
  const receipt = await txMint.wait();

  // Mint emits IncreaseLiquidity + Transfer (ERC721). We just print success.
  console.log("position minted. tx:", receipt?.hash);
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
